<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViXTTS - Chuyển văn bản thành giọng nói</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 900px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .loading {
            display: none;
        }
        .audio-player {
            display: none;
            margin-top: 20px;
        }
        .status-bar {
            margin: 20px 0;
        }
        .stats-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .form-label {
            font-weight: 500;
        }
        .header-title {
            color: #3b5998;
            font-weight: 700;
            margin-bottom: 25px;
        }
        .badge-gpu {
            position: absolute;
            right: 20px;
            top: 20px;
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .settings-section {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center header-title">ViXTTS - Chuyển văn bản thành giọng nói</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <div id="gpuBadge" class="badge-gpu" style="display: none;">GPU Enabled</div>
                
                <form id="ttsForm">
                    <div class="mb-3">
                        <label for="text" class="form-label">Văn bản</label>
                        <textarea class="form-control" id="text" name="text" rows="6" placeholder="Nhập văn bản tiếng Việt hoặc nhiều ngôn ngữ khác..." required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="voiceFile" class="form-label">File giọng mẫu (mp3, wav)</label>
                        <input class="form-control" type="file" id="voiceFile" name="voice_file" accept=".mp3,.wav" required>
                        <div class="form-text">Tải lên một file âm thanh chứa mẫu giọng nói bạn muốn mô phỏng</div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-title">Cài đặt nâng cao</div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="language" class="form-label">Ngôn ngữ</label>
                                <select class="form-select" id="language" name="language">
                                    <option value="vi" selected>Tiếng Việt</option>
                                    <option value="en">Tiếng Anh</option>
                                    <option value="zh-cn">Tiếng Trung</option>
                                    <option value="fr">Tiếng Pháp</option>
                                    <option value="de">Tiếng Đức</option>
                                    <option value="ja">Tiếng Nhật</option>
                                    <option value="ko">Tiếng Hàn</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="numWorkers" class="form-label">Số luồng xử lý</label>
                                <select class="form-select" id="numWorkers" name="num_workers">
                                    <option value="1">1 luồng</option>
                                    <option value="2">2 luồng</option>
                                    <option value="4" selected>4 luồng</option>
                                    <option value="8">8 luồng</option>
                                    <option value="16">16 luồng</option>
                                    <option value="32">32 luồng</option>
                                    <option value="64">64 luồng</option>
                                </select>
                                <div class="form-text">Số luồng càng cao, xử lý càng nhanh (tùy thuộc vào phần cứng)</div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="outputFormat" class="form-label">Định dạng đầu ra</label>
                                <select class="form-select" id="outputFormat" name="output_format">
                                    <option value="wav" selected>WAV</option>
                                    <option value="mp3">MP3</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="normalize" name="normalize" checked>
                            <label class="form-check-label" for="normalize">
                                Chuẩn hóa văn bản
                            </label>
                            <div class="form-text">Chuẩn hóa văn bản giúp cải thiện chất lượng phát âm</div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="submitBtn">Tạo giọng nói</button>
                    </div>
                </form>
                
                <div class="loading text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Đang xử lý, vui lòng đợi...</p>
                </div>
                
                <div class="status-bar progress" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
                
                <div class="audio-player text-center">
                    <h5 class="mb-3">Kết quả tổng hợp giọng nói</h5>
                    <audio controls class="w-100" id="audioPlayer"></audio>
                    <div class="mt-3">
                        <a href="#" class="btn btn-success" id="downloadBtn">Tải xuống</a>
                    </div>
                </div>
                
                <div class="stats-box" style="display: none;">
                    <h5>Thống kê thời gian xử lý:</h5>
                    <ul id="statsData" class="list-group list-group-flush">
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                Trạng thái hệ thống
            </div>
            <div class="card-body">
                <div id="systemStatus" class="d-flex justify-content-between align-items-center">
                    <div>Đang kiểm tra trạng thái...</div>
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Kiểm tra trạng thái server khi trang được tải
            checkServerStatus();
            
            // Form xử lý
            $('#ttsForm').on('submit', function(e) {
                e.preventDefault();
                
                let formData = new FormData();
                formData.append('text', $('#text').val());
                formData.append('voice_file', $('#voiceFile')[0].files[0]);
                formData.append('language', $('#language').val());
                formData.append('num_workers', $('#numWorkers').val());
                formData.append('output_format', $('#outputFormat').val());
                formData.append('normalize', $('#normalize').is(':checked'));
                
                $('.loading').show();
                $('.status-bar').show();
                $('.audio-player').hide();
                $('.stats-box').hide();
                $('#submitBtn').prop('disabled', true);
                
                $.ajax({
                    url: '/synthesize',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        $('.loading').hide();
                        $('.status-bar').hide();
                        $('.audio-player').show();
                        $('.stats-box').show();
                        $('#submitBtn').prop('disabled', false);
                        
                        // Hiển thị thống kê
                        $('#statsData').empty();
                        for (const [key, value] of Object.entries(response.stats)) {
                            $('#statsData').append(`<li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${formatStatKey(key)}</span>
                                <span class="badge bg-primary rounded-pill">${value}</span>
                            </li>`);
                        }
                        
                        // Cập nhật audio player
                        $('#audioPlayer').attr('src', `/download/${response.audio_file}`);
                        $('#downloadBtn').attr('href', `/download/${response.audio_file}`);
                        $('#downloadBtn').attr('download', response.audio_file);
                    },
                    error: function(xhr) {
                        $('.loading').hide();
                        $('.status-bar').hide();
                        $('#submitBtn').prop('disabled', false);
                        
                        let errorMsg = 'Đã xảy ra lỗi khi xử lý yêu cầu.';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        
                        alert('Lỗi: ' + errorMsg);
                    }
                });
            });
            
            // Kiểm tra trạng thái server
            function checkServerStatus() {
                $.ajax({
                    url: '/status',
                    type: 'GET',
                    success: function(response) {
                        let statusHtml = '';
                        
                        if (response.model_loaded) {
                            statusHtml += '<div class="text-success"><strong>Mô hình:</strong> Đã tải</div>';
                        } else {
                            statusHtml += '<div class="text-warning"><strong>Mô hình:</strong> Chưa tải</div>';
                        }
                        
                        if (response.gpu_available) {
                            statusHtml += '<div class="text-success"><strong>GPU:</strong> Khả dụng</div>';
                            $('#gpuBadge').show();
                            
                            // Hiển thị thông tin GPU
                            if (response.gpu_info) {
                                const gpuInfo = response.gpu_info;
                                statusHtml += `<div class="mt-2">
                                    <small class="text-muted">
                                        <strong>GPU:</strong> ${gpuInfo.device_name}<br>
                                        <strong>Bộ nhớ sử dụng:</strong> ${gpuInfo.memory_allocated}
                                    </small>
                                </div>`;
                            }
                        } else {
                            statusHtml += '<div class="text-warning"><strong>GPU:</strong> Không khả dụng (đang sử dụng CPU)</div>';
                        }
                        
                        $('#systemStatus').html(statusHtml);
                    },
                    error: function() {
                        $('#systemStatus').html('<div class="text-danger">Không thể kết nối đến server</div>');
                    }
                });
            }
            
            // Format các khóa thống kê để hiển thị
            function formatStatKey(key) {
                switch(key) {
                    case 'conditioning_time':
                        return 'Thời gian chuẩn bị';
                    case 'inference_time':
                        return 'Thời gian tổng hợp';
                    case 'save_time':
                        return 'Thời gian lưu file';
                    case 'total_time':
                        return 'Tổng thời gian';
                    default:
                        return key.replace(/_/g, ' ');
                }
            }
        });
    </script>
</body>
</html>